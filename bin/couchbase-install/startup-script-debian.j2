#!/bin/bash
# This script install couchbase server on debien to create a cluster of couchbase server

# Download the meta package 
curl -O https://packages.couchbase.com/releases/couchbase-release/couchbase-release-1.0-amd64.deb

# Install the meta package
sudo dpkg -i couchbase-release-1.0-amd64.deb

# Update the package list
sudo apt-get update

# Install couchbase server
sudo apt-get install -y couchbase-server-community


# remove the meta package
rm couchbase-release-1.0-amd64.deb

# Init a couchbase cluster 


# check if we are in the master node based on the hostname -a  
# if we are in the master node, we will init the cluster
if [[ $(hostname -a) == {{ master_node_name }} ]]; then
    echo "Init the cluster" 
    /opt/couchbase/bin/couchbase-cli cluster-init -c {{ master_node_hostname }}:8091 --cluster-username={{ admin_username }} --cluster-password={{admin_password}} 
    
    # add the other nodes to the cluster

    {% for node in nodes %}
      # Add nodes
    /opt/couchbase/bin/couchbase-cli server-add -c {{ master_node_hostname }}:8091 --server-add={{ node }}:8091 --server-add-username={{ admin_username }} --server-add-password={{ admin_password }} --username={{ admin_username }} --password={{ admin_password }}

    {% endfor %}
    # Rebalance
    /opt/couchbase/bin/couchbase-cli rebalance -c {{ master_node_hostname }}:8091 -u {{ admin_username }} -p {{ admin_password }}
fi
